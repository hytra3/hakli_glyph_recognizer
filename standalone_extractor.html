<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symbol Extraction Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .canvas-container {
            position: relative;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useCallback, useEffect } = React;

        // Lucide icons as simple SVG components
        const Upload = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        );

        const Download = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="17,8 12,13 7,8"/>
                <line x1="12" y1="2" x2="12" y2="13"/>
            </svg>
        );

        const Trash2 = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3,6 5,6 21,6"/>
                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );

        const Scissors = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="6" cy="6" r="3"/>
                <path d="M8.12 8.12L12 12"/>
                <path d="M20 4L8.12 15.88"/>
                <circle cx="6" cy="18" r="3"/>
                <path d="M14.8 14.8L20 20"/>
            </svg>
        );

        const SymbolExtractor = () => {
            const [uploadedImage, setUploadedImage] = useState(null);
            const [extractedSymbols, setExtractedSymbols] = useState([]);
            const [currentSelection, setCurrentSelection] = useState(null);
            const [selectionMode, setSelectionMode] = useState(false);
            const [imageScale, setImageScale] = useState(1);
            const [imageOffset, setImageOffset] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            const [symbolCounter, setSymbolCounter] = useState(1);
            
            const canvasRef = useRef(null);
            const imageRef = useRef(null);

            // Handle image upload
            const handleImageUpload = useCallback((event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setUploadedImage(e.target.result);
                        setExtractedSymbols([]);
                        setCurrentSelection(null);
                        setImageScale(1);
                        setImageOffset({ x: 0, y: 0 });
                    };
                    reader.readAsDataURL(file);
                }
            }, []);

            // Get mouse position relative to canvas
            const getMousePos = useCallback((e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }, []);

            // Convert canvas coordinates to image coordinates
            const canvasToImage = useCallback((canvasPos) => {
                return {
                    x: (canvasPos.x - imageOffset.x) / imageScale,
                    y: (canvasPos.y - imageOffset.y) / imageScale
                };
            }, [imageScale, imageOffset]);

            // Handle mouse down for selection
            const handleMouseDown = useCallback((e) => {
                if (!selectionMode || !imageRef.current) return;
                
                const mousePos = getMousePos(e);
                const imagePos = canvasToImage(mousePos);
                
                if (e.shiftKey) {
                    setIsDragging(true);
                    setDragStart({ x: e.clientX, y: e.clientY });
                } else {
                    setCurrentSelection({
                        startX: imagePos.x,
                        startY: imagePos.y,
                        endX: imagePos.x,
                        endY: imagePos.y
                    });
                }
            }, [selectionMode, getMousePos, canvasToImage]);

            // Handle mouse move
            const handleMouseMove = useCallback((e) => {
                if (isDragging) {
                    const deltaX = e.clientX - dragStart.x;
                    const deltaY = e.clientY - dragStart.y;
                    
                    setImageOffset(prev => ({
                        x: prev.x + deltaX,
                        y: prev.y + deltaY
                    }));
                    
                    setDragStart({ x: e.clientX, y: e.clientY });
                    return;
                }

                if (!currentSelection || !selectionMode) return;
                
                const mousePos = getMousePos(e);
                const imagePos = canvasToImage(mousePos);
                
                setCurrentSelection(prev => ({
                    ...prev,
                    endX: imagePos.x,
                    endY: imagePos.y
                }));
            }, [currentSelection, selectionMode, getMousePos, canvasToImage, isDragging, dragStart]);

            // Handle mouse up
            const handleMouseUp = useCallback(() => {
                setIsDragging(false);
            }, []);

            // Draw image and selections on canvas
            const drawCanvas = useCallback(() => {
                const canvas = canvasRef.current;
                const img = imageRef.current;
                if (!canvas || !img) return;

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw image
                ctx.save();
                ctx.translate(imageOffset.x, imageOffset.y);
                ctx.scale(imageScale, imageScale);
                ctx.drawImage(img, 0, 0);
                ctx.restore();

                // Draw extracted symbol outlines
                extractedSymbols.forEach((symbol, index) => {
                    const x = symbol.bounds.x * imageScale + imageOffset.x;
                    const y = symbol.bounds.y * imageScale + imageOffset.y;
                    const width = symbol.bounds.width * imageScale;
                    const height = symbol.bounds.height * imageScale;

                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, width, height);
                    
                    ctx.fillStyle = 'rgba(16, 185, 129, 0.8)';
                    ctx.fillRect(x, y - 20, 30, 20);
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.fillText(`#${index + 1}`, x + 5, y - 7);
                });

                // Draw current selection
                if (currentSelection) {
                    const startX = Math.min(currentSelection.startX, currentSelection.endX) * imageScale + imageOffset.x;
                    const startY = Math.min(currentSelection.startY, currentSelection.endY) * imageScale + imageOffset.y;
                    const width = Math.abs(currentSelection.endX - currentSelection.startX) * imageScale;
                    const height = Math.abs(currentSelection.endY - currentSelection.startY) * imageScale;

                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(startX, startY, width, height);
                    ctx.setLineDash([]);
                    
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
                    ctx.fillRect(startX, startY, width, height);
                }
            }, [imageScale, imageOffset, extractedSymbols, currentSelection]);

            // Extract symbol from selection
            const extractSymbol = useCallback(() => {
                if (!currentSelection || !imageRef.current) return;

                const img = imageRef.current;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const bounds = {
                    x: Math.min(currentSelection.startX, currentSelection.endX),
                    y: Math.min(currentSelection.startY, currentSelection.endY),
                    width: Math.abs(currentSelection.endX - currentSelection.startX),
                    height: Math.abs(currentSelection.endY - currentSelection.startY)
                };

                if (bounds.width < 10 || bounds.height < 10) {
                    alert('Selection too small. Please select a larger area.');
                    return;
                }

                canvas.width = bounds.width;
                canvas.height = bounds.height;

                ctx.drawImage(
                    img,
                    bounds.x, bounds.y, bounds.width, bounds.height,
                    0, 0, bounds.width, bounds.height
                );

                const symbolData = {
                    id: symbolCounter,
                    name: `symbol_${symbolCounter.toString().padStart(3, '0')}`,
                    bounds: bounds,
                    imageData: canvas.toDataURL('image/png'),
                    timestamp: new Date().toISOString()
                };

                setExtractedSymbols(prev => [...prev, symbolData]);
                setSymbolCounter(prev => prev + 1);
                setCurrentSelection(null);
            }, [currentSelection, symbolCounter]);

            // Delete extracted symbol
            const deleteSymbol = useCallback((index) => {
                setExtractedSymbols(prev => prev.filter((_, i) => i !== index));
            }, []);

            // Download single symbol
            const downloadSymbol = useCallback((symbol) => {
                const link = document.createElement('a');
                link.download = `${symbol.name}.png`;
                link.href = symbol.imageData;
                link.click();
            }, []);

            // Download all symbols
            const downloadAllSymbols = useCallback(() => {
                extractedSymbols.forEach((symbol, index) => {
                    setTimeout(() => {
                        downloadSymbol(symbol);
                    }, index * 500);
                });
            }, [extractedSymbols, downloadSymbol]);

            // Export symbols data as JSON
            const exportSymbolsData = useCallback(() => {
                const exportData = {
                    source_image: 'uploaded_inscription.jpg',
                    extraction_date: new Date().toISOString(),
                    symbols: extractedSymbols.map(symbol => ({
                        id: symbol.id,
                        name: symbol.name,
                        bounds: symbol.bounds,
                        image_file: `${symbol.name}.png`
                    }))
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'extracted_symbols.json';
                link.click();
                
                URL.revokeObjectURL(url);
            }, [extractedSymbols]);

            // Zoom controls
            const zoomIn = () => setImageScale(prev => Math.min(prev * 1.2, 5));
            const zoomOut = () => setImageScale(prev => Math.max(prev / 1.2, 0.1));
            const resetView = () => {
                setImageScale(1);
                setImageOffset({ x: 0, y: 0 });
            };

            useEffect(() => {
                drawCanvas();
            }, [drawCanvas]);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseup', handleMouseUp);
                
                return () => {
                    canvas.removeEventListener('mousemove', handleMouseMove);
                    canvas.removeEventListener('mouseup', handleMouseUp);
                };
            }, [handleMouseMove, handleMouseUp]);

            return (
                <div className="max-w-7xl mx-auto p-6 bg-gray-50 min-h-screen">
                    <div className="bg-white rounded-lg shadow-lg p-8">
                        <h1 className="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                            <Scissors />
                            Symbol Extraction Tool
                            <span className="text-sm font-normal text-gray-500 ml-2">for Archaeological Inscriptions</span>
                        </h1>

                        <div className="grid grid-cols-1 xl:grid-cols-4 gap-6">
                            {/* Controls Panel */}
                            <div className="space-y-6">
                                {/* Image Upload */}
                                <div className="space-y-3">
                                    <label className="block text-sm font-medium text-gray-700">
                                        Upload Inscription Image
                                    </label>
                                    <div className="flex items-center justify-center w-full">
                                        <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                            <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                                <Upload />
                                                <p className="text-xs text-gray-500 mt-2">Click to upload image</p>
                                            </div>
                                            <input
                                                type="file"
                                                className="hidden"
                                                accept="image/*"
                                                onChange={handleImageUpload}
                                            />
                                        </label>
                                    </div>
                                </div>

                                {/* View Controls */}
                                {uploadedImage && (
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h3 className="font-semibold text-blue-800 mb-3">View Controls</h3>
                                        <div className="space-y-2">
                                            <div className="flex gap-2">
                                                <button onClick={zoomIn} className="flex-1 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                                    Zoom In
                                                </button>
                                                <button onClick={zoomOut} className="flex-1 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                                    Zoom Out
                                                </button>
                                            </div>
                                            <button onClick={resetView} className="w-full bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                                                Reset View
                                            </button>
                                            <div className="text-xs text-blue-600 text-center">
                                                Zoom: {(imageScale * 100).toFixed(0)}%
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Extraction Controls */}
                                {uploadedImage && (
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h3 className="font-semibold text-green-800 mb-3">Symbol Extraction</h3>
                                        <div className="space-y-3">
                                            <button
                                                onClick={() => setSelectionMode(!selectionMode)}
                                                className={`w-full px-4 py-2 rounded font-medium transition-colors ${
                                                    selectionMode 
                                                        ? 'bg-red-600 text-white hover:bg-red-700' 
                                                        : 'bg-green-600 text-white hover:bg-green-700'
                                                }`}
                                            >
                                                {selectionMode ? 'Cancel Selection' : 'Start Selecting'}
                                            </button>
                                            
                                            {currentSelection && (
                                                <button
                                                    onClick={extractSymbol}
                                                    className="w-full bg-blue-600 text-white px-4 py-2 rounded font-medium hover:bg-blue-700"
                                                >
                                                    Extract Symbol
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {/* Export Controls */}
                                {extractedSymbols.length > 0 && (
                                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                        <h3 className="font-semibold text-purple-800 mb-3">Export Symbols</h3>
                                        <div className="space-y-2">
                                            <button onClick={downloadAllSymbols} className="w-full bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700 flex items-center justify-center gap-2">
                                                <Download />
                                                Download All Images
                                            </button>
                                            <button onClick={exportSymbolsData} className="w-full bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700 flex items-center justify-center gap-2">
                                                <Download />
                                                Export JSON Data
                                            </button>
                                            <div className="text-xs text-purple-600 text-center">
                                                {extractedSymbols.length} symbols extracted
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Canvas Panel */}
                            <div className="xl:col-span-2">
                                <h3 className="font-semibold text-gray-800 mb-4">Image Workspace</h3>
                                
                                <div className="relative bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200" style={{height: '600px'}}>
                                    {uploadedImage ? (
                                        <div className="relative w-full h-full">
                                            <canvas
                                                ref={canvasRef}
                                                width={800}
                                                height={600}
                                                className="absolute top-0 left-0 w-full h-full"
                                                onMouseDown={handleMouseDown}
                                                style={{ cursor: selectionMode ? 'crosshair' : 'default' }}
                                            />
                                            <img
                                                ref={imageRef}
                                                src={uploadedImage}
                                                alt="Source inscription"
                                                className="hidden"
                                                onLoad={drawCanvas}
                                            />
                                        </div>
                                    ) : (
                                        <div className="flex items-center justify-center h-full text-gray-500">
                                            <div className="text-center">
                                                <p className="text-lg font-medium mb-2">Upload an image to start</p>
                                                <p className="text-sm">Select and extract individual symbols</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Extracted Symbols Panel */}
                            <div className="space-y-4">
                                <h3 className="font-semibold text-gray-800">
                                    Extracted Symbols ({extractedSymbols.length})
                                </h3>
                                
                                <div className="max-h-96 overflow-y-auto space-y-3">
                                    {extractedSymbols.map((symbol, index) => (
                                        <div key={symbol.id} className="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                            <div className="flex items-start gap-3">
                                                <img
                                                    src={symbol.imageData}
                                                    alt={symbol.name}
                                                    className="w-16 h-16 object-contain bg-white border rounded"
                                                />
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-medium text-gray-800 truncate">
                                                        {symbol.name}
                                                    </p>
                                                    <p className="text-xs text-gray-500">
                                                        {symbol.bounds.width.toFixed(0)} Ã— {symbol.bounds.height.toFixed(0)}px
                                                    </p>
                                                    <div className="flex gap-1 mt-2">
                                                        <button
                                                            onClick={() => downloadSymbol(symbol)}
                                                            className="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                                                        >
                                                            <Download />
                                                        </button>
                                                        <button
                                                            onClick={() => deleteSymbol(index)}
                                                            className="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600"
                                                        >
                                                            <Trash2 />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<SymbolExtractor />, document.getElementById('root'));
    </script>
</body>
</html>