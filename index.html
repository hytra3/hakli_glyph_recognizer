<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hakli Glyph Recognizer - Modular v2</title>
    <meta name="description" content="Ancient South Arabian script recognition tool for field documentation">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#5d4e6d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hakli">
    <link rel="apple-touch-icon" href="favicon.svg">
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ancient-purple': '#5d4e6d',
                        'stone': '#8b7d6b',
                        'clay': '#a67c52',
                        'patina': '#6b8e7f',
                        'ochre': '#b8956a',
                        'rust': '#a0674f',
                        'stone-light': '#a69988',
                        'stone-dark': '#6d6355',
                    }
                }
            }
        }
    </script>
    
    <!-- OpenCV -->
    <script>
        var isOpenCvReady = false;
        function onOpenCvReady() {
            isOpenCvReady = true;
            console.log('‚úÖ OpenCV.js is ready');
        }
    </script>
    <script async src="https://docs.opencv.org/4.5.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    
    <!-- Custom Styles -->
    <style>
        .detection-box {
            position: absolute;
            pointer-events: auto;
            z-index: 10;
            border: 3px solid;
            border-radius: 4px;
            cursor: pointer;
        }
        .detection-box.validated-correct { border-color: #6b8e7f; background: rgba(107, 142, 127, 0.25); }
        .detection-box.validated-incorrect { border-color: #a0674f; background: rgba(239, 68, 68, 0.25); }
        .detection-box.unvalidated { border-color: #8b7d6b; background: rgba(59, 130, 246, 0.25); }
        .detection-box.selected { border-color: #b8956a; background: rgba(245, 158, 11, 0.3); border-width: 4px; }
        .detection-box.uncertain { border-style: dashed; border-color: #f97316; background: rgba(249, 115, 22, 0.15); }

        .detection-label {
            position: absolute;
            top: -25px;
            left: 0;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            border-radius: 3px;
            white-space: nowrap;
            opacity: 0.9;
        }
        
        .reading-order-badge {
            position: absolute;
            top: -20px;
            left: -20px;
            width: 28px;
            height: 28px;
            background-color: #b8956a;
            border: 2px solid #8d7350;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            z-index: 20;
        }
        
        .canvas-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- ========================================== -->
    <!-- BACKEND MODULES (Non-React)               -->
    <!-- ========================================== -->
    
    <!-- Core -->
    <script src="src/core/config.js"></script>
    <script src="src/utils/helpers.js"></script>
    
    <!-- Storage -->
    <script src="src/storage/hki.js"></script>
    <script src="src/storage/cache.js"></script>
    <script src="src/storage/corrections.js"></script>
    <script src="src/storage/export.js"></script>
    <script src="src/storage/drive-sync.js"></script>
    
    <!-- Recognition -->
    <script src="src/recognition/preprocessing.js"></script>
    <script src="src/recognition/isolation.js"></script>
    <script src="src/recognition/matching.js"></script>
    <script src="src/recognition/nms.js"></script>
    <script src="src/recognition/validation.js"></script>
    <script src="src/recognition/template-learning.js"></script>
    
    <!-- Reading & Transcription -->
    <script src="src/reading/reading.js"></script>
    <script src="src/reading/transcription.js"></script>

    <!-- ========================================== -->
    <!-- STATE MANAGEMENT                          -->
    <!-- ========================================== -->
    <script src="src/core/state.js"></script>

    <!-- ========================================== -->
    <!-- REACT HOOKS                               -->
    <!-- ========================================== -->
    <script type="text/babel" src="src/hooks/useAppState.js"></script>
    <script type="text/babel" src="src/hooks/useHistory.js"></script>
    <script type="text/babel" src="src/hooks/useRecognition.js"></script>

    <!-- ========================================== -->
    <!-- REACT COMPONENTS                          -->
    <!-- ========================================== -->
    <script type="text/babel" src="src/components/common/CommonComponents.jsx"></script>
    <script type="text/babel" src="src/components/detection/DetectionComponents.jsx"></script>
    <script type="text/babel" src="src/components/panels/PreprocessingPanel.jsx"></script>
    <script type="text/babel" src="src/components/panels/TranscriptionPanel.jsx"></script>
    <script type="text/babel" src="src/components/modals/GlyphEditorModal.jsx"></script>

    <!-- ========================================== -->
    <!-- MAIN APPLICATION                          -->
    <!-- ========================================== -->
    <script type="text/babel">
        const APP_VERSION = 'v2.0.0-modular';
        
        // Verify modules loaded
        console.log('üöÄ Hakli Glyph Recognizer - Modular ' + APP_VERSION);
        
        const modulesLoaded = {
            // Backend
            config: typeof CONFIG !== 'undefined',
            utils: typeof Utils !== 'undefined',
            hki: typeof HKIStorage !== 'undefined',
            cache: typeof CacheStorage !== 'undefined',
            corrections: typeof CorrectionMemory !== 'undefined',
            export: typeof ExportUtils !== 'undefined',
            driveSync: typeof DriveSync !== 'undefined',
            // Recognition
            isolation: typeof Isolation !== 'undefined',
            matching: typeof Matching !== 'undefined',
            preprocessing: typeof Preprocessing !== 'undefined',
            nms: typeof NMS !== 'undefined',
            // State
            appState: typeof AppState !== 'undefined',
            // Hooks
            useAppState: typeof useAppState !== 'undefined',
            useHistory: typeof useHistory !== 'undefined',
            useRecognition: typeof useRecognition !== 'undefined',
            // Components
            collapsibleSection: typeof CollapsibleSection !== 'undefined',
            detectionBox: typeof DetectionBox !== 'undefined',
            glyphEditorModal: typeof GlyphEditorModal !== 'undefined'
        };
        
        console.log('üì¶ Module status:', modulesLoaded);
        
        const missingModules = Object.entries(modulesLoaded)
            .filter(([k, v]) => !v)
            .map(([k]) => k);
        
        if (missingModules.length > 0) {
            console.warn('‚ö†Ô∏è Missing modules:', missingModules.join(', '));
        } else {
            console.log('‚úÖ All modules loaded successfully');
        }

        // ============================================
        // MAIN APP COMPONENT
        // ============================================
        function HakliGlyphRecognizer() {
            const { useState, useEffect, useRef, useCallback } = React;
            
            // Use the centralized state hook
            const appState = useAppState();
            const { state, filteredResults, orderedResults } = appState;
            
            // Refs
            const imageRef = useRef(null);
            const imageContainerRef = useRef(null);
            const preprocessCanvasRef = useRef(null);
            const originalCanvasRef = useRef(null);
            const fileInputRef = useRef(null);
            
            // History hook
            const history = useHistory(state, {
                setRecognitionResults: appState.setRecognitionResults,
                setValidations: appState.setValidations,
                setReadingOrder: appState.setReadingOrder,
                setWordBoundaries: appState.setWordBoundaries,
                setLineBreaks: appState.setLineBreaks,
                setColumnBreaks: appState.setColumnBreaks
            });
            
            // Recognition hook
            const recognition = useRecognition(state, appState, {
                imageRef,
                imageContainerRef
            });
            
            // Load glyph chart on mount
            useEffect(() => {
                const loadChart = async () => {
                    appState.setChartStatus('loading');
                    try {
                        const response = await fetch('Hakli_glyphs.JSON');
                        const data = await response.json();
                        appState.setChart(data);
                        console.log(`‚úÖ Loaded ${data.glyphs.length} glyphs`);
                        
                        // Load glyph images
                        let loaded = 0;
                        const total = data.glyphs.length;
                        
                        for (const glyph of data.glyphs) {
                            if (glyph.images?.primary) {
                                const img = new Image();
                                img.onload = () => {
                                    appState.setLoadedGlyphImage(glyph.id, img);
                                    appState.setGlyphThumbnail(glyph.id, img.src);
                                    loaded++;
                                    appState.setImageLoadProgress({ loaded, total });
                                };
                                img.onerror = () => {
                                    loaded++;
                                    appState.setImageLoadProgress({ loaded, total });
                                };
                                img.src = glyph.images.primary;
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load chart:', error);
                        appState.setChartStatus('error');
                    }
                };
                
                loadChart();
            }, []);
            
            // Handle image upload
            const handleImageUpload = useCallback((event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                appState.setImageLoading(true);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    appState.setImage(e.target.result);
                    appState.setImageLoading(false);
                    
                    // Reset recognition state
                    appState.setRecognitionResults([]);
                    appState.setValidations({});
                    appState.setIsolatedGlyphs([]);
                    appState.setReadingOrder([]);
                    appState.setWordBoundaries([]);
                    appState.setLineBreaks([]);
                    appState.setColumnBreaks([]);
                    history.clearHistory();
                };
                reader.onerror = () => {
                    alert('Failed to read image file');
                    appState.setImageLoading(false);
                };
                reader.readAsDataURL(file);
            }, [appState, history]);
            
            // Copy to clipboard
            const copyToClipboard = useCallback((text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('‚úÖ Copied to clipboard!');
                }).catch(() => {
                    alert('‚ùå Failed to copy');
                });
            }, []);
            
            // Text-to-speech
            const speak = useCallback((text, lang = 'en') => {
                if (!('speechSynthesis' in window)) {
                    alert('Text-to-speech not supported');
                    return;
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang === 'ar' ? 'ar-SA' : 'en-US';
                speechSynthesis.speak(utterance);
            }, []);

            // ============================================
            // RENDER
            // ============================================
            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="bg-ancient-purple text-white shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <span className="text-3xl">üìú</span>
                                    <div>
                                        <h1 className="text-xl font-bold">Hakli Glyph Recognizer</h1>
                                        <p className="text-sm text-purple-200">{APP_VERSION} - Modular Architecture</p>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-3">
                                    {/* Chart status */}
                                    <div className={`px-3 py-1 rounded-full text-sm ${
                                        state.chart.loadStatus === 'loaded' 
                                            ? 'bg-patina' 
                                            : state.chart.loadStatus === 'loading'
                                            ? 'bg-ochre'
                                            : 'bg-rust'
                                    }`}>
                                        {state.chart.loadStatus === 'loaded' 
                                            ? `‚úÖ ${state.chart.data?.glyphs?.length || 0} glyphs`
                                            : state.chart.loadStatus === 'loading'
                                            ? `‚è≥ Loading... ${state.chart.imageLoadProgress.loaded}/${state.chart.imageLoadProgress.total}`
                                            : '‚ùå Error'
                                        }
                                    </div>
                                    
                                    {/* Undo/Redo */}
                                    <button
                                        onClick={history.undo}
                                        disabled={!history.canUndo}
                                        className="p-2 rounded hover:bg-white/20 disabled:opacity-50"
                                        title="Undo"
                                    >
                                        ‚Ü©Ô∏è
                                    </button>
                                    <button
                                        onClick={history.redo}
                                        disabled={!history.canRedo}
                                        className="p-2 rounded hover:bg-white/20 disabled:opacity-50"
                                        title="Redo"
                                    >
                                        ‚Ü™Ô∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        <div className="grid grid-cols-12 gap-6">
                            {/* Left Sidebar - Controls */}
                            <aside className="col-span-3 space-y-4">
                                {/* Image Upload */}
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="font-bold text-gray-700 mb-3">üì∑ Image</h3>
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept="image/*"
                                        onChange={handleImageUpload}
                                        className="hidden"
                                    />
                                    <button
                                        onClick={() => fileInputRef.current?.click()}
                                        className="w-full px-4 py-3 bg-ancient-purple text-white rounded-lg hover:bg-[#4a3d5a] transition-colors font-medium"
                                    >
                                        {state.image.original ? 'üîÑ Change Image' : 'üì§ Upload Image'}
                                    </button>
                                </div>
                                
                                {/* Preprocessing Panel */}
                                {state.image.original && (
                                    <PreprocessingPanel
                                        preprocessing={state.preprocessing}
                                        onUpdate={appState.updatePreprocessing}
                                        onReset={appState.resetPreprocessing}
                                        onApply={() => {/* Apply preprocessing */}}
                                        isCollapsed={state.ui.collapsed.preprocessing}
                                        onToggleCollapse={() => appState.togglePanel('preprocessing')}
                                        showPreview={state.preprocessing.showPreview}
                                        onTogglePreview={() => appState.updatePreprocessing('showPreview', !state.preprocessing.showPreview)}
                                        preprocessCanvasRef={preprocessCanvasRef}
                                        originalCanvasRef={originalCanvasRef}
                                    />
                                )}
                                
                                {/* Recognition Controls */}
                                {state.image.original && (
                                    <div className="bg-white rounded-lg shadow p-4">
                                        <h3 className="font-bold text-gray-700 mb-3">üîç Recognition</h3>
                                        <button
                                            onClick={recognition.recognizeGlyphs}
                                            disabled={state.recognition.isProcessing || state.chart.loadStatus !== 'loaded'}
                                            className="w-full px-4 py-3 bg-patina text-white rounded-lg hover:bg-[#5a7d6e] transition-colors font-medium disabled:bg-gray-300"
                                        >
                                            {state.recognition.isProcessing 
                                                ? `‚è≥ Processing... ${state.recognition.progress.current}/${state.recognition.progress.total}`
                                                : 'üîç Recognize Glyphs'
                                            }
                                        </button>
                                        
                                        {state.recognition.results.length > 0 && (
                                            <div className="mt-3 text-sm text-gray-600">
                                                Found {state.recognition.results.length} glyphs
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {/* Transcription Panel */}
                                {state.recognition.results.length > 0 && (
                                    <TranscriptionPanel
                                        recognitionResults={filteredResults}
                                        readingOrder={state.reading.order}
                                        readingDirection={state.reading.direction}
                                        wordBoundaries={state.reading.wordBoundaries}
                                        lineBreaks={state.reading.lineBreaks}
                                        columnBreaks={state.reading.columnBreaks}
                                        translationEnglish={state.translation.english}
                                        translationArabic={state.translation.arabic}
                                        onDirectionChange={appState.setReadingDirection}
                                        onTranslationEnglishChange={appState.setTranslationEnglish}
                                        onTranslationArabicChange={appState.setTranslationArabic}
                                        onAutoDetectOrder={() => {
                                            if (typeof ReadingOrder !== 'undefined') {
                                                const direction = ReadingOrder.detectDirection(filteredResults);
                                                const order = ReadingOrder.generateOrder(filteredResults, direction);
                                                appState.setReadingDirection(direction);
                                                appState.setReadingOrder(order);
                                            }
                                        }}
                                        onCopyToClipboard={copyToClipboard}
                                        onSpeak={speak}
                                        isCollapsed={state.ui.collapsed.viewMode}
                                        onToggleCollapse={() => appState.togglePanel('viewMode')}
                                    />
                                )}
                            </aside>
                            
                            {/* Main Area - Image & Detections */}
                            <div className="col-span-6">
                                <div className="bg-white rounded-lg shadow p-4">
                                    {state.image.original ? (
                                        <div 
                                            ref={imageContainerRef}
                                            className="canvas-container relative"
                                        >
                                            <img
                                                ref={imageRef}
                                                src={state.image.display || state.image.original}
                                                alt="Inscription"
                                                className="max-w-full h-auto"
                                                style={{
                                                    transform: `rotate(${state.image.rotation}deg)`
                                                }}
                                            />
                                            
                                            {/* Detection boxes */}
                                            {filteredResults.map((result, index) => (
                                                <DetectionBox
                                                    key={index}
                                                    detection={result}
                                                    index={index}
                                                    isSelected={state.interaction.selectedRegions.has(index)}
                                                    isValidated={!!state.recognition.validations[index]}
                                                    validationResult={state.recognition.validations[index]?.isCorrect}
                                                    isUncertain={result.confidence < 0.6}
                                                    showLabel={true}
                                                    showArabicLabel={state.ui.showArabicLabels}
                                                    viewMode={state.reading.viewMode}
                                                    readingOrderIndex={
                                                        state.reading.viewMode === 'reading' 
                                                            ? state.reading.order.indexOf(index)
                                                            : null
                                                    }
                                                    scale={{ x: 1, y: 1 }}
                                                    onClick={(idx) => appState.toggleRegionSelection(idx)}
                                                    onDoubleClick={(idx) => appState.setCorrectionMode(idx)}
                                                />
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-96 text-gray-400">
                                            <span className="text-6xl mb-4">üì∑</span>
                                            <p className="text-lg">Upload an inscription image to begin</p>
                                            <p className="text-sm mt-2">Supports JPG, PNG, WebP</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Right Sidebar - Detection List */}
                            <aside className="col-span-3">
                                {filteredResults.length > 0 ? (
                                    <div className="bg-white rounded-lg shadow p-4">
                                        <div className="flex items-center justify-between mb-3">
                                            <h3 className="font-bold text-gray-700">üîç Detections</h3>
                                            <span className="text-sm text-gray-500">
                                                {filteredResults.length} found
                                            </span>
                                        </div>
                                        
                                        {/* View mode toggle */}
                                        <div className="flex gap-2 mb-4">
                                            <button
                                                onClick={() => appState.setViewMode('detection')}
                                                className={`flex-1 px-3 py-2 rounded text-sm ${
                                                    state.reading.viewMode === 'detection'
                                                        ? 'bg-ancient-purple text-white'
                                                        : 'bg-gray-100 text-gray-700'
                                                }`}
                                            >
                                                üîç Detection
                                            </button>
                                            <button
                                                onClick={() => appState.setViewMode('reading')}
                                                className={`flex-1 px-3 py-2 rounded text-sm ${
                                                    state.reading.viewMode === 'reading'
                                                        ? 'bg-ancient-purple text-white'
                                                        : 'bg-gray-100 text-gray-700'
                                                }`}
                                            >
                                                üìñ Reading
                                            </button>
                                        </div>
                                        
                                        {/* Detection list */}
                                        <div className="max-h-[60vh] overflow-y-auto space-y-2">
                                            <DetectionList
                                                detections={filteredResults}
                                                validations={state.recognition.validations}
                                                selectedRegions={state.interaction.selectedRegions}
                                                viewMode={state.reading.viewMode}
                                                readingOrder={state.reading.order}
                                                wordBoundaries={state.reading.wordBoundaries}
                                                lineBreaks={state.reading.lineBreaks}
                                                columnBreaks={state.reading.columnBreaks}
                                                layout="list"
                                                onSelect={(idx) => appState.toggleRegionSelection(idx)}
                                                onValidate={recognition.validateDetection}
                                                onCorrect={(idx, glyph) => {
                                                    if (glyph) {
                                                        recognition.correctDetection(idx, glyph);
                                                    } else {
                                                        appState.setCorrectionMode(idx);
                                                    }
                                                }}
                                                onDelete={(idx) => {
                                                    history.takeSnapshot();
                                                    recognition.deleteDetection(idx);
                                                }}
                                                onToggleWordBoundary={appState.toggleWordBoundary}
                                            />
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-white rounded-lg shadow p-6 text-center text-gray-400">
                                        <span className="text-4xl">üîç</span>
                                        <p className="mt-2">No detections yet</p>
                                        <p className="text-sm mt-1">Run recognition to detect glyphs</p>
                                    </div>
                                )}
                            </aside>
                        </div>
                    </main>
                    
                    {/* Modals */}
                    {state.ui.modals.glyphEditor && (
                        <GlyphEditorModal
                            mode={state.ui.modals.glyphEditor.mode}
                            glyph={state.ui.modals.glyphEditor.glyph}
                            equivalenceChart={state.chart.data}
                            setEquivalenceChart={appState.setChart}
                            loadedGlyphImages={state.chart.loadedImages}
                            setLoadedGlyphImages={(images) => {
                                Object.entries(images).forEach(([id, img]) => {
                                    appState.setLoadedGlyphImage(id, img);
                                });
                            }}
                            glyphThumbnails={state.chart.thumbnails}
                            setGlyphThumbnails={(thumbs) => {
                                Object.entries(thumbs).forEach(([id, thumb]) => {
                                    appState.setGlyphThumbnail(id, thumb);
                                });
                            }}
                            onClose={() => appState.setModal('glyphEditor', null)}
                        />
                    )}
                </div>
            );
        }

        // Mount the app
        ReactDOM.createRoot(document.getElementById('root')).render(<HakliGlyphRecognizer />);
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((reg) => console.log('‚úÖ Service Worker registered'))
                    .catch((err) => console.error('‚ùå SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
