<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hakli Glyph Merger</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üîÄ Hakli Glyph Merger</h1>
            <p class="text-gray-600 mb-6">merge two Hakli glyph JSON files, use 'merge' to add training data to equivalence chart, push result to github (November 2025)</p>

            <div class="space-y-6">
                <!-- File 1: Base -->
                <div class="p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
                    <h3 class="font-semibold text-blue-900 mb-2">üìÑ Base File (Hakli_glyphs.JSON)</h3>
                    <p class="text-sm text-gray-600 mb-3">Your current/main glyph file</p>
                    <input 
                        type="file" 
                        id="baseFile" 
                        accept=".json,.JSON"
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"
                    />
                    <div id="baseStatus" class="mt-2 text-sm"></div>
                </div>

                <!-- File 2: Training -->
                <div class="p-4 bg-green-50 border-2 border-green-200 rounded-lg">
                    <h3 class="font-semibold text-green-900 mb-2">üìÑ Training File (new glyphs to add)</h3>
                    <p class="text-sm text-gray-600 mb-3">The file with additional glyphs to merge</p>
                    <input 
                        type="file" 
                        id="trainingFile" 
                        accept=".json,.JSON"
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200"
                    />
                    <div id="trainingStatus" class="mt-2 text-sm"></div>
                </div>

                <!-- Merge Options -->
                <div class="p-4 bg-purple-50 border-2 border-purple-200 rounded-lg">
                    <h3 class="font-semibold text-purple-900 mb-3">‚öôÔ∏è Merge Options</h3>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="radio" name="mergeStrategy" value="skip" checked class="text-purple-600">
                            <span class="text-sm text-gray-700"><strong>Skip duplicates</strong> - Keep base file version if glyph ID exists in both</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="mergeStrategy" value="overwrite" class="text-purple-600">
                            <span class="text-sm text-gray-700"><strong>Overwrite duplicates</strong> - Use training file version if glyph ID exists in both</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="mergeStrategy" value="merge" class="text-purple-600">
                            <span class="text-sm text-gray-700"><strong>Merge duplicates</strong> - Combine images (add training variants/examples to base)</span>
                        </label>
                    </div>
                </div>

                <!-- Merge Button -->
                <button 
                    id="mergeButton"
                    onclick="mergeFiles()"
                    disabled
                    class="w-full px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed font-semibold text-lg"
                >
                    üîÄ Merge Files
                </button>

                <!-- Results -->
                <div id="results" class="hidden">
                    <div class="p-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg">
                        <h3 class="font-semibold text-yellow-900 mb-2">üìä Merge Results</h3>
                        <div id="mergeStats" class="text-sm text-gray-700 space-y-1"></div>
                        <button 
                            id="downloadButton"
                            onclick="downloadMerged()"
                            class="mt-4 w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold"
                        >
                            üíæ Download Merged Hakli_glyphs.JSON
                        </button>
                    </div>
                </div>

                <!-- Log -->
                <div id="logContainer" class="hidden">
                    <div class="p-4 bg-gray-50 border-2 border-gray-300 rounded-lg">
                        <h3 class="font-semibold text-gray-900 mb-2">üìù Merge Log</h3>
                        <div id="log" class="text-xs font-mono text-gray-600 max-h-64 overflow-y-auto whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let baseData = null;
        let trainingData = null;
        let mergedData = null;

        // File loading
        document.getElementById('baseFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const text = await file.text();
                    baseData = JSON.parse(text);
                    document.getElementById('baseStatus').innerHTML = 
                        `<span class="text-green-600">‚úÖ Loaded: ${baseData.glyphs?.length || 0} glyphs</span>`;
                    checkReady();
                } catch (err) {
                    document.getElementById('baseStatus').innerHTML = 
                        `<span class="text-red-600">‚ùå Error: ${err.message}</span>`;
                    baseData = null;
                }
            }
        });

        document.getElementById('trainingFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const text = await file.text();
                    trainingData = JSON.parse(text);
                    document.getElementById('trainingStatus').innerHTML = 
                        `<span class="text-green-600">‚úÖ Loaded: ${trainingData.glyphs?.length || 0} glyphs</span>`;
                    checkReady();
                } catch (err) {
                    document.getElementById('trainingStatus').innerHTML = 
                        `<span class="text-red-600">‚ùå Error: ${err.message}</span>`;
                    trainingData = null;
                }
            }
        });

        function checkReady() {
            document.getElementById('mergeButton').disabled = !(baseData && trainingData);
        }

        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.textContent += message + '\n';
            document.getElementById('logContainer').classList.remove('hidden');
        }

        function mergeFiles() {
            const strategy = document.querySelector('input[name="mergeStrategy"]:checked').value;
            
            // Clear previous results
            document.getElementById('log').textContent = '';
            document.getElementById('logContainer').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            log('üîÄ Starting merge process...');
            log(`Strategy: ${strategy}`);
            log(`Base glyphs: ${baseData.glyphs.length}`);
            log(`Training glyphs: ${trainingData.glyphs.length}`);
            log('');

            // Create merged data structure
            mergedData = {
                source_image: baseData.source_image || trainingData.source_image,
                extraction_date: new Date().toISOString(),
                merge_info: {
                    base_glyphs: baseData.glyphs.length,
                    training_glyphs: trainingData.glyphs.length,
                    merge_strategy: strategy,
                    merge_date: new Date().toISOString()
                },
                glyphs: []
            };

            // Create a map of base glyphs by ID
            const baseGlyphMap = new Map();
            baseData.glyphs.forEach(glyph => {
                baseGlyphMap.set(glyph.id, glyph);
            });

            // Track statistics
            let added = 0;
            let skipped = 0;
            let overwritten = 0;
            let merged = 0;
            let variantsAdded = 0;
            let examplesAdded = 0;

            // First, add all base glyphs to merged data
            baseData.glyphs.forEach(glyph => {
                mergedData.glyphs.push(JSON.parse(JSON.stringify(glyph)));
            });

            // Process training glyphs
            trainingData.glyphs.forEach(trainingGlyph => {
                const baseGlyph = baseGlyphMap.get(trainingGlyph.id);

                if (!baseGlyph) {
                    // New glyph - add it
                    mergedData.glyphs.push(JSON.parse(JSON.stringify(trainingGlyph)));
                    added++;
                    log(`‚úÖ Added new glyph: ID ${trainingGlyph.id} (${trainingGlyph.name})`);
                } else {
                    // Duplicate found - apply strategy
                    if (strategy === 'skip') {
                        // Keep base version
                        skipped++;
                        log(`‚è≠Ô∏è  Skipped duplicate: ID ${trainingGlyph.id} (${trainingGlyph.name}) - kept base version`);
                    } else if (strategy === 'overwrite') {
                        // Replace with training version
                        const index = mergedData.glyphs.findIndex(g => g.id === trainingGlyph.id);
                        if (index === -1) {
                            mergedData.glyphs.push(JSON.parse(JSON.stringify(trainingGlyph)));
                        } else {
                            mergedData.glyphs[index] = JSON.parse(JSON.stringify(trainingGlyph));
                        }
                        overwritten++;
                        log(`üîÑ Overwrote: ID ${trainingGlyph.id} (${trainingGlyph.name}) with training version`);
                    } else if (strategy === 'merge') {
                        // Merge images
                        const mergedGlyph = JSON.parse(JSON.stringify(baseGlyph));
                        
                        let variantsAddedCount = 0;
                        let examplesAddedCount = 0;
                        
                        // Add training variants to base variants (avoid duplicates)
                        if (trainingGlyph.images.variants && trainingGlyph.images.variants.length > 0) {
                            if (!mergedGlyph.images.variants) {
                                mergedGlyph.images.variants = [];
                            }
                            trainingGlyph.images.variants.forEach(variant => {
                                if (!mergedGlyph.images.variants.includes(variant)) {
                                    mergedGlyph.images.variants.push(variant);
                                    variantsAddedCount++;
                                }
                            });
                        }
                        
                        // Add training examples to base examples (avoid duplicates)
                        if (trainingGlyph.images.examples && trainingGlyph.images.examples.length > 0) {
                            if (!mergedGlyph.images.examples) {
                                mergedGlyph.images.examples = [];
                            }
                            trainingGlyph.images.examples.forEach(example => {
                                if (!mergedGlyph.images.examples.includes(example)) {
                                    mergedGlyph.images.examples.push(example);
                                    examplesAddedCount++;
                                }
                            });
                        }

                        variantsAdded += variantsAddedCount;
                        examplesAdded += examplesAddedCount;

                        const index = mergedData.glyphs.findIndex(g => g.id === trainingGlyph.id);
                        if (index === -1) {
                            mergedData.glyphs.push(mergedGlyph);
                        } else {
                            mergedData.glyphs[index] = mergedGlyph;
                        }
                        merged++;
                        log(`üîó Merged images: ID ${trainingGlyph.id} (${trainingGlyph.name}) - added ${variantsAddedCount} variants, ${examplesAddedCount} examples`);
                    }
                }

                // Remove from base map to track what we've processed
                baseGlyphMap.delete(trainingGlyph.id);
            });

            // Sort by ID
            mergedData.glyphs.sort((a, b) => a.id - b.id);

            log('');
            log('‚úÖ Merge complete!');
            log(`Total glyphs in merged file: ${mergedData.glyphs.length}`);

            // Display results
            document.getElementById('mergeStats').innerHTML = `
                <div><strong>Total glyphs:</strong> ${mergedData.glyphs.length}</div>
                <div><strong>New glyphs added:</strong> ${added}</div>
                ${skipped > 0 ? `<div><strong>Duplicates skipped:</strong> ${skipped}</div>` : ''}
                ${overwritten > 0 ? `<div><strong>Duplicates overwritten:</strong> ${overwritten}</div>` : ''}
                ${merged > 0 ? `<div><strong>Duplicates merged:</strong> ${merged}</div>` : ''}
                ${variantsAdded > 0 ? `<div class="text-green-700"><strong>‚ú® Variants added:</strong> ${variantsAdded}</div>` : ''}
                ${examplesAdded > 0 ? `<div class="text-green-700"><strong>‚ú® Examples added:</strong> ${examplesAdded}</div>` : ''}
                <div><strong>From base file:</strong> ${baseData.glyphs.length} glyphs kept</div>
            `;
            document.getElementById('results').classList.remove('hidden');
        }

        function downloadMerged() {
            const jsonStr = JSON.stringify(mergedData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Hakli_glyphs.JSON';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('');
            log('üíæ Downloaded merged file: Hakli_glyphs.JSON');
        }
    </script>
</body>
</html>
